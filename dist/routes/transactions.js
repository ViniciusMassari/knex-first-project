"use strict";var d=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var I=Object.getOwnPropertyNames;var v=Object.prototype.hasOwnProperty;var F=(n,t)=>{for(var s in t)d(n,s,{get:t[s],enumerable:!0})},w=(n,t,s,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let e of I(t))!v.call(n,e)&&e!==s&&d(n,e,{get:()=>t[e],enumerable:!(a=A(t,e))||a.enumerable});return n};var S=n=>w(d({},"__esModule",{value:!0}),n);var D={};F(D,{transactionRoutes:()=>k});module.exports=S(D);var r=require("zod");var g=require("knex");var y=require("dotenv"),m=require("zod");process.env.NODE_ENV==="test"?(0,y.config)({path:".env.test"}):(0,y.config)();var E=m.z.object({NODE_ENV:m.z.enum(["development","production","test"]).default("production"),DATABASE_URL:m.z.string(),PORT:m.z.number().default(3333)}),p=E.safeParse(process.env);if(p.success===!1)throw console.error("\u{1F440} invalid enviroment variable ",p.error.format()),new Error("invalid enviroment variable");var l=p.data;if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL is required");var h={client:"sqlite",connection:{filename:l.DATABASE_URL},useNullAsDefault:!0,migrations:{extension:"ts",directory:"./db/migrations"}},u=(0,g.knex)(h);var T=require("crypto"),i=class{static async getAllTransactions(t){return await u("transactions").where("session_id",t).select()}static async getTransactionsSummary(t){return await u("transactions").where("session_id",t).sum("amount",{as:"amount"}).first()}static async getTransaction(t,s){return await u("transactions").where({session_id:s,id:t}).first()}static async createTransaction(t,s){let{title:a,amount:e,type:c}=t;await u("transactions").insert({id:(0,T.randomUUID)(),title:a,amount:c==="credit"?e:e*-1,session_id:s})}};var R=require("crypto"),o=class{static async getTransactionsSummary(t,s){let{sessionId:a}=t.cookies,e=await i.getTransactionsSummary(a);return s.status(200).send({summary:e})}static async createTransaction(t,s){let a=r.z.object({title:r.z.string(),amount:r.z.number(),type:r.z.enum(["credit","debit"])}),e=t.cookies?.sessionId;e||(e=(0,R.randomUUID)(),s.cookie("sessionId",e,{path:"/",maxAge:6048e5}));let c=a.parse(t.body);return await i.createTransaction(c,e),s.status(201).send()}static async getTransaction(t,s){let a=r.z.object({id:r.z.string().uuid()}),{sessionId:e}=t.cookies,{id:c}=a.parse(t.params);return{transaction:await i.getTransaction(c,e)}}static async getAllTransactions(t,s){let{sessionId:a}=t.cookies;return{transactions:await i.getAllTransactions(a)}}};async function f(n,t){let s=n.cookies.sessionId;return s?!s:t.status(401).send({error:"Unathourized"})}async function k(n){n.get("/summary",{preHandler:[f]},o.getTransactionsSummary),n.get("/:id",{preHandler:[f]},o.getTransaction),n.get("/",{preHandler:[f]},o.getAllTransactions),n.post("/",o.createTransaction)}0&&(module.exports={transactionRoutes});
