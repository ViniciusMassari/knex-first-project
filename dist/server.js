"use strict";var F=Object.create;var g=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var E=Object.getPrototypeOf,D=Object.prototype.hasOwnProperty;var _=(s,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of k(t))!D.call(s,n)&&n!==e&&g(s,n,{get:()=>t[n],enumerable:!(r=S(t,n))||r.enumerable});return s};var T=(s,t,e)=>(e=s!=null?F(E(s)):{},_(t||!s||!s.__esModule?g(e,"default",{value:s,enumerable:!0}):e,s));var I=T(require("fastify"));var R=require("knex");var y=require("dotenv"),f=require("zod");process.env.NODE_ENV==="test"?(0,y.config)({path:".env.test"}):(0,y.config)();var b=f.z.object({NODE_ENV:f.z.enum(["development","production","test"]).default("production"),DATABASE_URL:f.z.string(),PORT:f.z.number().default(3333)}),d=b.safeParse(process.env);if(d.success===!1)throw console.error("\u{1F440} invalid enviroment variable ",d.error.format()),new Error("invalid enviroment variable");var p=d.data;if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL is required");var U={client:"sqlite",connection:{filename:p.DATABASE_URL},useNullAsDefault:!0,migrations:{extension:"ts",directory:"./db/migrations"}},i=(0,R.knex)(U);var c=require("zod");var x=require("crypto"),o=class{static async getAllTransactions(t){return await i("transactions").where("session_id",t).select()}static async getTransactionsSummary(t){return await i("transactions").where("session_id",t).sum("amount",{as:"amount"}).first()}static async getTransaction(t,e){return await i("transactions").where({session_id:e,id:t}).first()}static async createTransaction(t,e){let{title:r,amount:n,type:m}=t;await i("transactions").insert({id:(0,x.randomUUID)(),title:r,amount:m==="credit"?n:n*-1,session_id:e})}};var v=require("crypto"),a=class{static async getTransactionsSummary(t,e){let{sessionId:r}=t.cookies,n=await o.getTransactionsSummary(r);return e.status(200).send({summary:n})}static async createTransaction(t,e){let r=c.z.object({title:c.z.string(),amount:c.z.number(),type:c.z.enum(["credit","debit"])}),n=t.cookies?.sessionId;n||(n=(0,v.randomUUID)(),e.cookie("sessionId",n,{path:"/",maxAge:6048e5}));let m=r.parse(t.body);return await o.createTransaction(m,n),e.status(201).send()}static async getTransaction(t,e){let r=c.z.object({id:c.z.string().uuid()}),{sessionId:n}=t.cookies,{id:m}=r.parse(t.params);return{transaction:await o.getTransaction(m,n)}}static async getAllTransactions(t,e){let{sessionId:r}=t.cookies;return{transactions:await o.getAllTransactions(r)}}};async function l(s,t){let e=s.cookies.sessionId;return e?!e:t.status(401).send({error:"Unathourized"})}async function A(s){s.get("/summary",{preHandler:[l]},a.getTransactionsSummary),s.get("/:id",{preHandler:[l]},a.getTransaction),s.get("/",{preHandler:[l]},a.getAllTransactions),s.post("/",a.createTransaction)}var w=T(require("@fastify/cookie")),u=(0,I.default)();u.register(w.default);u.register(A,{prefix:"transactions"});u.get("/hello",async(s,t)=>await i("transactions").where("amount",1e3).select("*"));u.listen({port:p.PORT}).then(()=>{console.log("HTTP Server Running")});
