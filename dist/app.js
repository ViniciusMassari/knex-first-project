"use strict";var k=Object.create;var u=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var D=Object.getPrototypeOf,_=Object.prototype.hasOwnProperty;var b=(s,t)=>{for(var e in t)u(s,e,{get:t[e],enumerable:!0})},g=(s,t,e,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of E(t))!_.call(s,n)&&n!==e&&u(s,n,{get:()=>t[n],enumerable:!(a=S(t,n))||a.enumerable});return s};var T=(s,t,e)=>(e=s!=null?k(D(s)):{},g(t||!s||!s.__esModule?u(e,"default",{value:s,enumerable:!0}):e,s)),U=s=>g(u({},"__esModule",{value:!0}),s);var N={};b(N,{app:()=>y});module.exports=U(N);var w=T(require("fastify"));var R=require("knex");var d=require("dotenv"),f=require("zod");process.env.NODE_ENV==="test"?(0,d.config)({path:".env.test"}):(0,d.config)();var q=f.z.object({NODE_ENV:f.z.enum(["development","production","test"]).default("production"),DATABASE_URL:f.z.string(),PORT:f.z.number().default(3333)}),l=q.safeParse(process.env);if(l.success===!1)throw console.error("\u{1F440} invalid enviroment variable ",l.error.format()),new Error("invalid enviroment variable");var x=l.data;if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL is required");var B={client:"sqlite",connection:{filename:x.DATABASE_URL},useNullAsDefault:!0,migrations:{extension:"ts",directory:"./db/migrations"}},i=(0,R.knex)(B);var c=require("zod");var A=require("crypto"),r=class{static async getAllTransactions(t){return await i("transactions").where("session_id",t).select()}static async getTransactionsSummary(t){return await i("transactions").where("session_id",t).sum("amount",{as:"amount"}).first()}static async getTransaction(t,e){return await i("transactions").where({session_id:e,id:t}).first()}static async createTransaction(t,e){let{title:a,amount:n,type:m}=t;await i("transactions").insert({id:(0,A.randomUUID)(),title:a,amount:m==="credit"?n:n*-1,session_id:e})}};var I=require("crypto"),o=class{static async getTransactionsSummary(t,e){let{sessionId:a}=t.cookies,n=await r.getTransactionsSummary(a);return e.status(200).send({summary:n})}static async createTransaction(t,e){let a=c.z.object({title:c.z.string(),amount:c.z.number(),type:c.z.enum(["credit","debit"])}),n=t.cookies?.sessionId;n||(n=(0,I.randomUUID)(),e.cookie("sessionId",n,{path:"/",maxAge:6048e5}));let m=a.parse(t.body);return await r.createTransaction(m,n),e.status(201).send()}static async getTransaction(t,e){let a=c.z.object({id:c.z.string().uuid()}),{sessionId:n}=t.cookies,{id:m}=a.parse(t.params);return{transaction:await r.getTransaction(m,n)}}static async getAllTransactions(t,e){let{sessionId:a}=t.cookies;return{transactions:await r.getAllTransactions(a)}}};async function p(s,t){let e=s.cookies.sessionId;return e?!e:t.status(401).send({error:"Unathourized"})}async function v(s){s.get("/summary",{preHandler:[p]},o.getTransactionsSummary),s.get("/:id",{preHandler:[p]},o.getTransaction),s.get("/",{preHandler:[p]},o.getAllTransactions),s.post("/",o.createTransaction)}var F=T(require("@fastify/cookie")),y=(0,w.default)();y.register(F.default);y.register(v,{prefix:"transactions"});y.get("/hello",async(s,t)=>await i("transactions").where("amount",1e3).select("*"));0&&(module.exports={app});
